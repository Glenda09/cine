<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Seleccionar asientos</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    #grid { width:100%; display:flex; flex-direction:column; align-items:center; }
    .seat { width:34px; height:34px; margin:4px; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600; box-shadow: inset 0 -2px 0 rgba(0,0,0,.12); }
    .LIBRE { background:#d0ebff; border:1px solid #74c0fc; }
    .HOLD { background:#ffe08a; border:1px solid #e67700; cursor:not-allowed; }
    .RESERVADO { background:#ffa8a8; border:1px solid #fa5252; cursor:not-allowed; }
    .COMPRADO { background:#ced4da; border:1px solid #868e96; cursor:not-allowed; }
    .selected { background:#51cf66 !important; border-color:#2f9e44 !important; color:#fff; }
    .legend .box{display:inline-flex;align-items:center;gap:6px;margin-right:16px}
    .screen {height:6px;background:linear-gradient(#bbb,#eee);border-radius:3px;margin:10px auto 16px;max-width:520px}
  </style>
  <script>
    async function loadSeats(funcionId){
      const res = await fetch(`/funcion/${funcionId}/asientos`);
      const list = await res.json();
      const grid = document.getElementById('grid');
      grid.innerHTML='';
      const selected = new Set();
      const seatMap = {};
      let maxRow = 0, maxCol = 0;
      list.forEach(s=>{ maxRow=Math.max(maxRow,s.fila); maxCol=Math.max(maxCol,s.columna); seatMap[`${s.fila}-${s.columna}`]=s; });
      for(let r=1;r<=maxRow;r++){
        const row = document.createElement('div');
        row.className = 'rowSeats d-flex align-items-center mb-1';
        const label = document.createElement('div');
        label.style.width='20px';
        label.textContent = String.fromCharCode(64+r);
        label.className = 'text-muted small';
        row.appendChild(label);
        for(let c=1;c<=maxCol;c++){
          const s = seatMap[`${r}-${c}`];
          const div = document.createElement('div');
          div.className = 'seat ' + (s? s.estado : 'FREE');
          div.textContent = c;
          if (s && s.estado==='LIBRE'){
            div.addEventListener('click', ()=>{ if(div.classList.contains('selected')){ div.classList.remove('selected'); selected.delete(s.id); } else { div.classList.add('selected'); selected.add(s.id); } updateSelected(); });
          }
          row.appendChild(div);
        }
        grid.appendChild(row);
      }
      window.getSelectedSeats = ()=>Array.from(selected);
      updateSelected();
    }
    function updateSelected(){
      const count = window.getSelectedSeats? window.getSelectedSeats().length : 0;
      document.getElementById('selCount').textContent = count;
    }
    function getAuthToken(){
      const m = document.cookie.match(/(?:^|; )AUTH=([^;]+)/);
      return (m? decodeURIComponent(m[1]) : null) || localStorage.getItem('AUTH');
    }
    async function reservar(funcionId){
      const ids = window.getSelectedSeats();
      if (!ids || ids.length===0){ alert('Selecciona al menos un asiento'); return; }
      const token = getAuthToken();
      const headers = {'Content-Type':'application/json','Accept':'application/json'};
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch('/api/reservas/hold', {
        method:'POST',
        headers,
        body: JSON.stringify({ funcionId: funcionId, asientoIds: ids }),
        credentials:'include'
      });
      if (res.status===401 || res.status===403){
        // Si por alguna razon no se pudo autenticar, redirige a login
        window.location.href='/login';
        return;
      }
      if (!res.ok){ const t=await res.text(); alert('No se pudo reservar: '+t); return; }
      const data = await res.json();
      window.location.href = `/checkout/start/${data.reservaId}`;
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const fid = document.getElementById('funcionId').value;
      loadSeats(fid);
      document.getElementById('btnReservar').addEventListener('click', ()=> reservar(parseInt(fid)) );
    });
  </script>
</head>
<body>
<header class="p-3 bg-dark text-white">
  <div class="container d-flex gap-3 align-items-center">
    <a class="text-light" href="/">← Inicio</a>
    <h1 class="h5 m-0">Seleccionar asientos</h1>
  </div>
</header>
<main class="container py-4">
  <input type="hidden" id="funcionId" th:value="${funcion.id}">
  <h4>Película <span th:text="${funcion.pelicula.titulo}"></span> — Sala <span th:text="${funcion.sala.nombre}"></span></h4>
  <p>Horario: <span th:text="${#temporals.format(funcion.horaInicio, 'dd/MM HH:mm')}"></span> — Precio base $<span th:text="${funcion.precioBase}"></span></p>
  <div class="legend mb-2 small">
    <span class="box"><span class="seat LIBRE" style="width:18px;height:18px"></span>Libre</span>
    <span class="box"><span class="seat selected" style="width:18px;height:18px"></span>Seleccionado</span>
    <span class="box"><span class="seat RESERVADO" style="width:18px;height:18px"></span>Ocupado</span>
  </div>
  <div class="screen"></div>
  <div id="grid" class="mb-3"></div>
  <div class="d-flex align-items-center gap-3">
    <div>Seleccionados: <b id="selCount">0</b></div>
    <button id="btnReservar" class="btn btn-primary">Reservar y pagar</button>
  </div>
</main>
</body>
</html>
